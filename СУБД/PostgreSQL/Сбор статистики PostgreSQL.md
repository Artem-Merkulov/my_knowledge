# Сбор статистики

Сбор статистики в PostgreSQL необходим для оптимизации производительности запросов и правильного выбора планов выполнения. Статистика помогает оптимизатору запросов принимать более обоснованные решения. В PostgreSQL статистика собирается автоматически, но вы также можете вручную инициировать процесс. Вот основные шаги для сбора статистики:

### 1. Автоматический сбор статистики

По умолчанию PostgreSQL использует процесс `autovacuum`, который автоматически собирает статистику для таблиц. Этот процесс запускается по расписанию и обрабатывает таблицы в соответствии с заданными параметрами.

### 2. Настройка параметров autovacuum

Вы можете настроить параметры `autovacuum` в файле конфигурации `postgresql.conf`. Вот несколько важных параметров:

- `autovacuum_max_workers`: максимальное количество рабочих процессов autovacuum.
- `autovacuum_naptime`: интервал времени между запусками autovacuum.
- `autovacuum_vacuum_threshold` и `autovacuum_vacuum_scale_factor`: параметры, определяющие, когда следует запускать процесс vacuum для таблицы.
- `autovacuum_analyze_threshold` и `autovacuum_analyze_scale_factor`: параметры, определяющие, когда следует запускать процесс analyze для сбора статистики.

### 3. Ручной сбор статистики

Вы можете вручную инициировать сбор статистики, используя команду `ANALYZE`. Это может быть полезно, если вы сделали значительные изменения в данных таблицы и хотите, чтобы оптимизатор запросов имел актуальную информацию.

```sql
ANALYZE имя_таблицы;
```

Если вы хотите собрать статистику для всех таблиц в базе данных, используйте:

```sql
ANALYZE;
```

### 4. Просмотр статистики

После сбора статистики вы можете просмотреть её с помощью системных представлений, таких как `pg_statistic`.

Пример запроса для получения информации о статистике для конкретной таблицы:
```sql
SELECT *
FROM pg_stats
WHERE tablename = 'имя_таблицы';
```

### 5. Использование команд VACUUM

Команда `VACUUM` очищает таблицы и может дополнительно собирать статистику:

```sql
VACUUM анализировать имя_таблицы;
```

### 6. Мониторинг и анализ

Используйте представления, такие как `pg_stat_user_tables`, чтобы следить за состоянием таблиц и частотой вызовов процессов `vacuum` и `analyze`:

```sql
SELECT relname, n_live_tup, n_dead_tup, last_vacuum, last_autovacuum, last_analyze, last_autoanalyze
FROM pg_stat_user_tables;
```

### Заключение

Регулярный сбор статистики является важной частью администрирования PostgreSQL. Настройка `autovacuum` и периодическая ручная инициатива `ANALYZE` помогут поддерживать производительность базы данных на высоком уровне.