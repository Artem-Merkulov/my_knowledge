# Возможности тестирования в DBT.

#### DQ-tests:
  - Воспроизводить любые виды тестов, какие можно воспроизвести с помощью SQL.
  - DQ-tests могут быть заданы в .yml, config(), dbt_project.yml. Поддерживается иерархия этих установок для тестов.
  - Невалидные данные можно материализовать в БД в отдельной схеме, по результатам тестирования. Дубликаты невалидных записей при повторном тестировании не возникают.
  - Использовать встроенные тесты в .yml (not_null, unique, references и т.п.) и писать собственные аналитические запросы.
  - Тестировать sources, seeds, models и всё, что возвращает результат и на что можно сослаться.
  - Записывать строки не прошедшие валидацию в отдельные таблицы, представления или ephemeral. Причём не только строки, а целые аналитические таблицы. И к ним можно прикручивать (например) BI для мониторинга проблем в данных. 
  - Устанавливать уровень серьёзности с различными условиями >,<,= и т.п. (предупреждение, ошибка).
  - Запускать DQ-тесты и unit-тесты отдельно друг от друга - для этого есть флаг dbt test --select test_type:unit.
  - В DQ-тестах можно фильтровать значения в тестируемом поле в .yml с помощью where или macro get_where_subquery  (relation). Можно создавать пользовательскую логику через macro get_where_subquery(relation).
  - Писать тест как макрос и вставлять его в модель или материализацию.
  - Использовать готовые DBT-пакеты с тестами.
  - Задавать диапазон допустимых значений динамически, через переменные.
#### Пакеты с DQ-тестами:
  - Использовать DQ-тесты из DBT-пакета dbt-utils или аналогичных пакетов.
  - Например найден готовый пакет DBT-expectations с тестами DQ, созданный на основе Great Expectations package for Python.
#### Unit-tests:
  - Реализован способ замены источников - источниками с эталонными данными, с последующей сверкой данных в приёмнике с эталонными данными. Режим запуска dbt проекта задаётся флагом unit_testing: true (обвязка модели макросом, который заменяет продовые таблицы на эталонные). 
  - Возможно unit-тестирование материализации отдельно от модели, через модель SELECT * FROM source (Таким образом отсекается логика модели - это актуально при использовании model_builder). Или unit-тестирование модели совместно с материализацией.
  - DBT-seeds можно использовать как источники эталонных данных для unit-тестов моделей и материализаций.
  - Unit-тестирование макросов на данный момент не изучено.
#### 2 способа реализации DQ в DBT-проекте:
  1. Невалидные данные обрабатываются при тестировании - на вход модели поступают только валидные данные (невалидные отсекаются при загрузке из источника).
  2. Тесты используются только для получения информации о проблемах в данных - невалидные данные обрабатываются в блоке if - else программы (модели или материализации).